import { createEffect, ofType } from '@ngrx/effects';
import { props } from '@ngrx/store';
import { of, Subject } from 'rxjs';
import { catchError, map, switchMap, tap } from 'rxjs/operators';
import { LoadingState } from '../model/loading-state';
import { convertResponseToError } from './convert-response-to-error';
function createTrackingAction(type, hasGlobalTag, tags, httpStatus, config) {
    if (typeof config === 'function') {
        return defineType(type, (...args) => ({
            ...config(...args),
            type,
            httpStatus,
            tags: hasGlobalTag ? ['global', ...tags] : [...tags],
        }));
    }
    const as = config ? config._as : 'empty';
    switch (as) {
        case 'empty':
            return defineType(type, () => ({
                type,
                httpStatus,
                tags: hasGlobalTag ? ['global', ...tags] : [...tags],
            }));
        case 'props':
            return defineType(type, 
            // eslint-disable-next-line @typescript-eslint/no-shadow
            (props) => ({
                ...props,
                type,
                httpStatus,
                tags: hasGlobalTag ? ['global', ...tags] : [...tags],
            }));
        default:
            throw new Error('Unexpected config.');
    }
}
function createTrackingFailureAction(type, hasGlobalTag, tags, httpStatus, config) {
    if (typeof config === 'function') {
        return defineType(type, (err, fallbackMsg, ...args) => ({
            httpStatus: httpStatus(err, fallbackMsg),
            ...config(...args),
            type,
            tags: hasGlobalTag ? ['global', ...tags] : [...tags],
        }));
    }
    const as = config ? config._as : 'empty';
    switch (as) {
        case 'empty':
            return defineType(type, (err, fallbackMsg) => ({
                httpStatus: httpStatus(err, fallbackMsg),
                type,
                tags: hasGlobalTag ? ['global', ...tags] : [...tags],
            }));
        case 'props':
            return defineType(type, 
            // eslint-disable-next-line @typescript-eslint/no-shadow
            (err, fallbackMsg, props) => ({
                httpStatus: httpStatus(err, fallbackMsg),
                ...props,
                type,
                tags: hasGlobalTag ? ['global', ...tags] : [...tags],
            }));
        default:
            throw new Error('Unexpected config.');
    }
}
function defineType(type, creator) {
    return Object.defineProperty(creator, 'type', {
        value: type,
        writable: false,
    });
}
export const createTrackingActions = (namespace, actionName, hasGlobalTag = true, tags = [namespace]) => ({
    loading: createTrackingAction(`[${namespace}] ${actionName}`, hasGlobalTag, tags, LoadingState.LOADING, props()),
    loaded: createTrackingAction(`[${namespace}] ${actionName}Success`, hasGlobalTag, tags, LoadingState.LOADED, props()),
    failure: createTrackingFailureAction(`[${namespace}] ${actionName}Failure`, hasGlobalTag, tags, convertResponseToError),
});
export const createTrackingEffect = (actions$, tackingAction, serviceCall, fallbackErrorMsg, 
// eslint-disable-next-line @typescript-eslint/no-empty-function
successFn = (httpContext) => { }) => createEffect(() => actions$.pipe(ofType(tackingAction.loading), switchMap((action) => serviceCall(action.request).pipe(map((payload) => tackingAction.loaded({ payload })), tap((successAction) => successFn({
    request: action.request,
    payload: successAction.payload,
})), catchError((e) => {
    console.error(e);
    const subjectMsg = new Subject();
    if (e.error instanceof Blob &&
        e.error.type === 'application/json') {
        e.error.text().then((errorBlobText) => {
            const errorJson = JSON.parse(errorBlobText);
            subjectMsg.next(tackingAction.failure(e, errorJson.error));
        });
    }
    else {
        return of(tackingAction.failure(e, fallbackErrorMsg));
    }
    return subjectMsg;
})))));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaHR0cC10cmFja2luZy1hY3Rpb25zLmZhY3RvcnkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9odHRwLXRyYWNraW5nL3NyYy9saWIvZnVuY3Rpb24vaHR0cC10cmFja2luZy1hY3Rpb25zLmZhY3RvcnkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFXLFlBQVksRUFBRSxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDOUQsT0FBTyxFQUFrQyxLQUFLLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFPcEUsT0FBTyxFQUFjLEVBQUUsRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDL0MsT0FBTyxFQUFFLFVBQVUsRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRWpFLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUN0RCxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQztBQTZCckUsU0FBUyxvQkFBb0IsQ0FDM0IsSUFBTyxFQUNQLFlBQXFCLEVBQ3JCLElBQWMsRUFDZCxVQUF3QixFQUN4QixNQUE2QjtJQUU3QixJQUFJLE9BQU8sTUFBTSxLQUFLLFVBQVUsRUFBRTtRQUNoQyxPQUFPLFVBQVUsQ0FDZixJQUFJLEVBQ0osQ0FBQyxHQUFHLElBQVcsRUFBRSxFQUFFLENBQ2pCLENBQXFDO1lBQ25DLEdBQUcsTUFBTSxDQUFDLEdBQUcsSUFBSSxDQUFDO1lBQ2xCLElBQUk7WUFDSixVQUFVO1lBQ1YsSUFBSSxFQUFFLFlBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQyxRQUFRLEVBQUUsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQztTQUNyRCxDQUFBLENBQ0osQ0FBQztLQUNIO0lBQ0QsTUFBTSxFQUFFLEdBQUcsTUFBTSxDQUFDLENBQUMsQ0FB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LE9BQU8sRUFBRSxFQUFFLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQyxFQUFFLE9BQU8sRUFBRSxDQUFDLENBQUMsRUFDbkQsR0FBRyxDQUFDLENBQUMsYUFBYSxFQUFFLEVBQUUsQ0FDcEIsU0FBUyxDQUFDO0lBQ1IsT0FBTyxFQUFFLE1BQU0sQ0FBQyxPQUFPO0lBQ3ZCLE9BQU8sRUFBRSxhQUFhLENBQUMsT0FBTztDQUMvQixDQUFDLENBQ0gsRUFDRCxVQUFVLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRTtJQUNmLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDakIsTUFBTSxVQUFVLEdBQUcsSUFBSSxPQUFPLEVBQVUsQ0FBQztJQUV6QyxJQUNFLENBQUMsQ0FBQyxLQUFLLFlBQVksSUFBSTtRQUN2QixDQUFDLENBQUMsS0FBSyxDQUFDLElBQUksS0FBSyxrQkFBa0IsRUFDbkM7UUFDQSxDQUFDLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLGFBQXFCLEVBQUUsRUFBRTtZQUM1QyxNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1lBQzVDLFVBQVUsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxDQUFDLEVBQUUsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7UUFDN0QsQ0FBQyxDQUFDLENBQUM7S0FDSjtTQUFNO1FBQ0wsT0FBTyxFQUFFLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxDQUFDLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQyxDQUFDO0tBQ3ZEO0lBQ0QsT0FBTyxVQUFVLENBQUM7QUFDcEIsQ0FBQyxDQUFDLENBQ0gsQ0FDRixDQUNGLENBQ0YsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFjdGlvbnMsIGNyZWF0ZUVmZmVjdCwgb2ZUeXBlIH0gZnJvbSAnQG5ncngvZWZmZWN0cyc7XHJcbmltcG9ydCB7IEFjdGlvbiwgQWN0aW9uQ3JlYXRvciwgQ3JlYXRvciwgcHJvcHMgfSBmcm9tICdAbmdyeC9zdG9yZSc7XHJcbmltcG9ydCB7XHJcbiAgQWN0aW9uQ3JlYXRvclByb3BzLFxyXG4gIEZ1bmN0aW9uV2l0aFBhcmFtZXRlcnNUeXBlLFxyXG4gIE5vdEFsbG93ZWRDaGVjayxcclxuICBUeXBlZEFjdGlvbixcclxufSBmcm9tICdAbmdyeC9zdG9yZS9zcmMvbW9kZWxzJztcclxuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgb2YsIFN1YmplY3QgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgY2F0Y2hFcnJvciwgbWFwLCBzd2l0Y2hNYXAsIHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuaW1wb3J0IHsgSHR0cFRyYWNraW5nRW50aXR5IH0gZnJvbSAnLi4vbW9kZWwvaHR0cC10cmFja2luZy1lbnRpdHknO1xyXG5pbXBvcnQgeyBMb2FkaW5nU3RhdGUgfSBmcm9tICcuLi9tb2RlbC9sb2FkaW5nLXN0YXRlJztcclxuaW1wb3J0IHsgY29udmVydFJlc3BvbnNlVG9FcnJvciB9IGZyb20gJy4vY29udmVydC1yZXNwb25zZS10by1lcnJvcic7XHJcblxyXG5mdW5jdGlvbiBjcmVhdGVUcmFja2luZ0FjdGlvbjxUIGV4dGVuZHMgc3RyaW5nPihcclxuICB0eXBlOiBULFxyXG4gIGhhc0dsb2JhbFRhZzogYm9vbGVhbixcclxuICB0YWdzOiBzdHJpbmdbXSxcclxuICBodHRwU3RhdHVzOiBMb2FkaW5nU3RhdGVcclxuKTogQWN0aW9uQ3JlYXRvcjxULCAoKSA9PiBUeXBlZEFjdGlvbjxUPj47XHJcblxyXG5mdW5jdGlvbiBjcmVhdGVUcmFja2luZ0FjdGlvbjxUIGV4dGVuZHMgc3RyaW5nLCBQIGV4dGVuZHMgb2JqZWN0PihcclxuICB0eXBlOiBULFxyXG4gIGhhc0dsb2JhbFRhZzogYm9vbGVhbixcclxuICB0YWdzOiBzdHJpbmdbXSxcclxuICBodHRwU3RhdHVzOiBMb2FkaW5nU3RhdGUsXHJcbiAgY29uZmlnOiBBY3Rpb25DcmVhdG9yUHJvcHM8UD4gfCBudWxsXHJcbik6IEFjdGlvbkNyZWF0b3I8VCwgKHByb3BzPzogUCkgPT4gUCAmIFR5cGVkQWN0aW9uPFQ+PjtcclxuXHJcbmZ1bmN0aW9uIGNyZWF0ZVRyYWNraW5nQWN0aW9uPFxyXG4gIFQgZXh0ZW5kcyBzdHJpbmcsXHJcbiAgUCBleHRlbmRzIGFueVtdLFxyXG4gIFIgZXh0ZW5kcyBvYmplY3RcclxuPihcclxuICB0eXBlOiBULFxyXG4gIGhhc0dsb2JhbFRhZzogYm9vbGVhbixcclxuICB0YWdzOiBzdHJpbmdbXSxcclxuICBodHRwU3RhdHVzOiBMb2FkaW5nU3RhdGUsXHJcbiAgY3JlYXRvcjogQ3JlYXRvcjxQLCBSPiAmIE5vdEFsbG93ZWRDaGVjazxSPlxyXG4pOiBGdW5jdGlvbldpdGhQYXJhbWV0ZXJzVHlwZTxQLCBSICYgVHlwZWRBY3Rpb248VD4+ICYgVHlwZWRBY3Rpb248VD47XHJcblxyXG5mdW5jdGlvbiBjcmVhdGVUcmFja2luZ0FjdGlvbjxUIGV4dGVuZHMgc3RyaW5nLCBDIGV4dGVuZHMgQ3JlYXRvcj4oXHJcbiAgdHlwZTogVCxcclxuICBoYXNHbG9iYWxUYWc6IGJvb2xlYW4sXHJcbiAgdGFnczogc3RyaW5nW10sXHJcbiAgaHR0cFN0YXR1czogTG9hZGluZ1N0YXRlLFxyXG4gIGNvbmZpZz86IHsgX2FzOiAncHJvcHMnIH0gfCBDXHJcbik6IEFjdGlvbkNyZWF0b3I8VD4ge1xyXG4gIGlmICh0eXBlb2YgY29uZmlnID09PSAnZnVuY3Rpb24nKSB7XHJcbiAgICByZXR1cm4gZGVmaW5lVHlwZShcclxuICAgICAgdHlwZSxcclxuICAgICAgKC4uLmFyZ3M6IGFueVtdKSA9PlxyXG4gICAgICAgIDxIdHRwVHJhY2tpbmdFbnRpdHkgJiBUeXBlZEFjdGlvbjxUPj57XHJcbiAgICAgICAgICAuLi5jb25maWcoLi4uYXJncyksXHJcbiAgICAgICAgICB0eXBlLFxyXG4gICAgICAgICAgaHR0cFN0YXR1cyxcclxuICAgICAgICAgIHRhZ3M6IGhhc0dsb2JhbFRhZyA/IFsnZ2xvYmFsJywgLi4udGFnc10gOiBbLi4udGFnc10sXHJcbiAgICAgICAgfVxyXG4gICAgKTtcclxuICB9XHJcbiAgY29uc3QgYXMgPSBjb25maWcgPyBjb25maWcuX2FzIDogJ2VtcHR5JztcclxuICBzd2l0Y2ggKGFzKSB7XHJcbiAgICBjYXNlICdlbXB0eSc6XHJcbiAgICAgIHJldHVybiBkZWZpbmVUeXBlKFxyXG4gICAgICAgIHR5cGUsXHJcbiAgICAgICAgKCkgPT5cclxuICAgICAgICAgIDxIdHRwVHJhY2tpbmdFbnRpdHkgJiBUeXBlZEFjdGlvbjxUPj57XHJcbiAgICAgICAgICAgIHR5cGUsXHJcbiAgICAgICAgICAgIGh0dHBTdGF0dXMsXHJcbiAgICAgICAgICAgIHRhZ3M6IGhhc0dsb2JhbFRhZyA/IFsnZ2xvYmFsJywgLi4udGFnc10gOiBbLi4udGFnc10sXHJcbiAgICAgICAgICB9XHJcbiAgICAgICk7XHJcbiAgICBjYXNlICdwcm9wcyc6XHJcbiAgICAgIHJldHVybiBkZWZpbmVUeXBlKFxyXG4gICAgICAgIHR5cGUsXHJcbiAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1zaGFkb3dcclxuICAgICAgICAocHJvcHM6IG9iamVjdCkgPT5cclxuICAgICAgICAgIDxIdHRwVHJhY2tpbmdFbnRpdHkgJiBUeXBlZEFjdGlvbjxUPj57XHJcbiAgICAgICAgICAgIC4uLnByb3BzLFxyXG4gICAgICAgICAgICB0eXBlLFxyXG4gICAgICAgICAgICBodHRwU3RhdHVzLFxyXG4gICAgICAgICAgICB0YWdzOiBoYXNHbG9iYWxUYWcgPyBbJ2dsb2JhbCcsIC4uLnRhZ3NdIDogWy4uLnRhZ3NdLFxyXG4gICAgICAgICAgfVxyXG4gICAgICApO1xyXG4gICAgZGVmYXVsdDpcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdVbmV4cGVjdGVkIGNvbmZpZy4nKTtcclxuICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGNyZWF0ZVRyYWNraW5nRmFpbHVyZUFjdGlvbjxcclxuICBUIGV4dGVuZHMgc3RyaW5nLFxyXG4gIGVyciBleHRlbmRzIGFueSxcclxuICBmYWxsYmFja01zZyBleHRlbmRzIHN0cmluZ1xyXG4+KFxyXG4gIHR5cGU6IFQsXHJcbiAgaGFzR2xvYmFsVGFnOiBib29sZWFuLFxyXG4gIHRhZ3M6IHN0cmluZ1tdLFxyXG4gIGh0dHBTdGF0dXM6IChlcnI6IGFueSwgZmFsbGJhY2tNc2c6IHN0cmluZykgPT4gRXJyb3JcclxuKTogQWN0aW9uQ3JlYXRvcjxULCAoZXJyOiBhbnksIGZhbGxiYWNrTXNnOiBzdHJpbmcpID0+IFR5cGVkQWN0aW9uPFQ+PjtcclxuXHJcbmZ1bmN0aW9uIGNyZWF0ZVRyYWNraW5nRmFpbHVyZUFjdGlvbjxcclxuICBUIGV4dGVuZHMgc3RyaW5nLFxyXG4gIGVyciBleHRlbmRzIGFueSxcclxuICBmYWxsYmFja01zZyBleHRlbmRzIHN0cmluZyxcclxuICBQIGV4dGVuZHMgb2JqZWN0XHJcbj4oXHJcbiAgdHlwZTogVCxcclxuICBoYXNHbG9iYWxUYWc6IGJvb2xlYW4sXHJcbiAgdGFnczogc3RyaW5nW10sXHJcbiAgaHR0cFN0YXR1czogKGVycjogYW55LCBmYWxsYmFja01zZzogc3RyaW5nKSA9PiBFcnJvcixcclxuICBjb25maWc6IEFjdGlvbkNyZWF0b3JQcm9wczxQPiAmIE5vdEFsbG93ZWRDaGVjazxQPlxyXG4pOiBBY3Rpb25DcmVhdG9yPFxyXG4gIFQsXHJcbiAgKFxyXG4gICAgZXJyOiBhbnksXHJcbiAgICBmYWxsYmFja01zZzogc3RyaW5nLFxyXG4gICAgcHJvcHM6IFAgJiBOb3RBbGxvd2VkQ2hlY2s8UD5cclxuICApID0+IFAgJiBUeXBlZEFjdGlvbjxUPlxyXG4+O1xyXG5cclxuZnVuY3Rpb24gY3JlYXRlVHJhY2tpbmdGYWlsdXJlQWN0aW9uPFQgZXh0ZW5kcyBzdHJpbmcsIEMgZXh0ZW5kcyBDcmVhdG9yPihcclxuICB0eXBlOiBULFxyXG4gIGhhc0dsb2JhbFRhZzogYm9vbGVhbixcclxuICB0YWdzOiBzdHJpbmdbXSxcclxuICBodHRwU3RhdHVzOiAoZXJyOiBhbnksIGZhbGxiYWNrTXNnOiBzdHJpbmcpID0+IEVycm9yLFxyXG4gIGNvbmZpZz86IHsgX2FzOiAncHJvcHMnIH0gfCBDXHJcbik6IEFjdGlvbkNyZWF0b3I8VD4ge1xyXG4gIGlmICh0eXBlb2YgY29uZmlnID09PSAnZnVuY3Rpb24nKSB7XHJcbiAgICByZXR1cm4gZGVmaW5lVHlwZShcclxuICAgICAgdHlwZSxcclxuICAgICAgKGVycjogYW55LCBmYWxsYmFja01zZzogc3RyaW5nLCAuLi5hcmdzOiBhbnlbXSkgPT5cclxuICAgICAgICA8SHR0cFRyYWNraW5nRW50aXR5ICYgVHlwZWRBY3Rpb248VD4+e1xyXG4gICAgICAgICAgaHR0cFN0YXR1czogaHR0cFN0YXR1cyhlcnIsIGZhbGxiYWNrTXNnKSxcclxuICAgICAgICAgIC4uLmNvbmZpZyguLi5hcmdzKSxcclxuICAgICAgICAgIHR5cGUsXHJcbiAgICAgICAgICB0YWdzOiBoYXNHbG9iYWxUYWcgPyBbJ2dsb2JhbCcsIC4uLnRhZ3NdIDogWy4uLnRhZ3NdLFxyXG4gICAgICAgIH1cclxuICAgICk7XHJcbiAgfVxyXG4gIGNvbnN0IGFzID0gY29uZmlnID8gY29uZmlnLl9hcyA6ICdlbXB0eSc7XHJcbiAgc3dpdGNoIChhcykge1xyXG4gICAgY2FzZSAnZW1wdHknOlxyXG4gICAgICByZXR1cm4gZGVmaW5lVHlwZShcclxuICAgICAgICB0eXBlLFxyXG4gICAgICAgIChlcnI6IGFueSwgZmFsbGJhY2tNc2c6IHN0cmluZykgPT5cclxuICAgICAgICAgIDxIdHRwVHJhY2tpbmdFbnRpdHkgJiBUeXBlZEFjdGlvbjxUPj57XHJcbiAgICAgICAgICAgIGh0dHBTdGF0dXM6IGh0dHBTdGF0dXMoZXJyLCBmYWxsYmFja01zZyksXHJcbiAgICAgICAgICAgIHR5cGUsXHJcbiAgICAgICAgICAgIHRhZ3M6IGhhc0dsb2JhbFRhZyA/IFsnZ2xvYmFsJywgLi4udGFnc10gOiBbLi4udGFnc10sXHJcbiAgICAgICAgICB9XHJcbiAgICAgICk7XHJcbiAgICBjYXNlICdwcm9wcyc6XHJcbiAgICAgIHJldHVybiBkZWZpbmVUeXBlKFxyXG4gICAgICAgIHR5cGUsXHJcbiAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1zaGFkb3dcclxuICAgICAgICAoZXJyOiBhbnksIGZhbGxiYWNrTXNnOiBzdHJpbmcsIHByb3BzOiBvYmplY3QpID0+XHJcbiAgICAgICAgICA8SHR0cFRyYWNraW5nRW50aXR5ICYgVHlwZWRBY3Rpb248VD4+e1xyXG4gICAgICAgICAgICBodHRwU3RhdHVzOiBodHRwU3RhdHVzKGVyciwgZmFsbGJhY2tNc2cpLFxyXG4gICAgICAgICAgICAuLi5wcm9wcyxcclxuICAgICAgICAgICAgdHlwZSxcclxuICAgICAgICAgICAgdGFnczogaGFzR2xvYmFsVGFnID8gWydnbG9iYWwnLCAuLi50YWdzXSA6IFsuLi50YWdzXSxcclxuICAgICAgICAgIH1cclxuICAgICAgKTtcclxuICAgIGRlZmF1bHQ6XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcignVW5leHBlY3RlZCBjb25maWcuJyk7XHJcbiAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBkZWZpbmVUeXBlPFQgZXh0ZW5kcyBzdHJpbmc+KFxyXG4gIHR5cGU6IFQsXHJcbiAgY3JlYXRvcjogQ3JlYXRvclxyXG4pOiBBY3Rpb25DcmVhdG9yPFQ+IHtcclxuICByZXR1cm4gPEFjdGlvbkNyZWF0b3I8VD4+T2JqZWN0LmRlZmluZVByb3BlcnR5KGNyZWF0b3IsICd0eXBlJywge1xyXG4gICAgdmFsdWU6IHR5cGUsXHJcbiAgICB3cml0YWJsZTogZmFsc2UsXHJcbiAgfSk7XHJcbn1cclxuXHJcbmV4cG9ydCBjb25zdCBjcmVhdGVUcmFja2luZ0FjdGlvbnMgPSA8VFJlcXVlc3QsIFRQYXlsb2FkPihcclxuICBuYW1lc3BhY2U6IHN0cmluZyxcclxuICBhY3Rpb25OYW1lOiBzdHJpbmcsXHJcbiAgaGFzR2xvYmFsVGFnID0gdHJ1ZSxcclxuICB0YWdzOiBzdHJpbmdbXSA9IFtuYW1lc3BhY2VdXHJcbik6IFRyYWNraW5nQWN0aW9uPFRSZXF1ZXN0LCBUUGF5bG9hZD4gPT4gKHtcclxuICBsb2FkaW5nOiBjcmVhdGVUcmFja2luZ0FjdGlvbihcclxuICAgIGBbJHtuYW1lc3BhY2V9XSAke2FjdGlvbk5hbWV9YCxcclxuICAgIGhhc0dsb2JhbFRhZyxcclxuICAgIHRhZ3MsXHJcbiAgICBMb2FkaW5nU3RhdGUuTE9BRElORyxcclxuICAgIHByb3BzPHsgcmVxdWVzdDogVFJlcXVlc3QgfT4oKVxyXG4gICksXHJcbiAgbG9hZGVkOiBjcmVhdGVUcmFja2luZ0FjdGlvbihcclxuICAgIGBbJHtuYW1lc3BhY2V9XSAke2FjdGlvbk5hbWV9U3VjY2Vzc2AsXHJcbiAgICBoYXNHbG9iYWxUYWcsXHJcbiAgICB0YWdzLFxyXG4gICAgTG9hZGluZ1N0YXRlLkxPQURFRCxcclxuICAgIHByb3BzPHsgcGF5bG9hZDogVFBheWxvYWQgfT4oKVxyXG4gICksXHJcbiAgZmFpbHVyZTogY3JlYXRlVHJhY2tpbmdGYWlsdXJlQWN0aW9uKFxyXG4gICAgYFske25hbWVzcGFjZX1dICR7YWN0aW9uTmFtZX1GYWlsdXJlYCxcclxuICAgIGhhc0dsb2JhbFRhZyxcclxuICAgIHRhZ3MsXHJcbiAgICBjb252ZXJ0UmVzcG9uc2VUb0Vycm9yXHJcbiAgKSxcclxufSk7XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIFRyYWNraW5nQWN0aW9uPFRSZXF1ZXN0LCBUUGF5bG9hZD4ge1xyXG4gIGxvYWRpbmc6ICgoYXR0cj86IHtcclxuICAgIHJlcXVlc3Q6IFRSZXF1ZXN0O1xyXG4gIH0pID0+IHsgcmVxdWVzdDogVFJlcXVlc3QgfSAmIFR5cGVkQWN0aW9uPHN0cmluZz4pICZcclxuICAgIFR5cGVkQWN0aW9uPHN0cmluZz47XHJcbiAgbG9hZGVkOiAoKGF0dHI/OiB7XHJcbiAgICBwYXlsb2FkOiBUUGF5bG9hZDtcclxuICB9KSA9PiB7IHBheWxvYWQ6IFRQYXlsb2FkIH0gJiBUeXBlZEFjdGlvbjxzdHJpbmc+KSAmXHJcbiAgICBUeXBlZEFjdGlvbjxzdHJpbmc+O1xyXG4gIGZhaWx1cmU6IEFjdGlvbkNyZWF0b3I8XHJcbiAgICBzdHJpbmcsXHJcbiAgICAoaHR0cFN0YXR1czogRXJyb3IsIGZhbGxiYWNrRXJyb3JNc2c6IHN0cmluZykgPT4gVHlwZWRBY3Rpb248c3RyaW5nPlxyXG4gID47XHJcbn1cclxuXHJcbmV4cG9ydCBjb25zdCBjcmVhdGVUcmFja2luZ0VmZmVjdCA9IDxUUmVxdWVzdCwgVFBheWxvYWQ+KFxyXG4gIGFjdGlvbnMkOiBBY3Rpb25zLFxyXG4gIHRhY2tpbmdBY3Rpb246IFRyYWNraW5nQWN0aW9uPFRSZXF1ZXN0LCBUUGF5bG9hZD4sXHJcbiAgc2VydmljZUNhbGw6IChyZXF1ZXN0OiBUUmVxdWVzdCkgPT4gT2JzZXJ2YWJsZTxUUGF5bG9hZD4sXHJcbiAgZmFsbGJhY2tFcnJvck1zZzogc3RyaW5nLFxyXG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZW1wdHktZnVuY3Rpb25cclxuICBzdWNjZXNzRm46IChodHRwQ29udGV4dDogeyByZXF1ZXN0OiBUUmVxdWVzdDsgcGF5bG9hZDogVFBheWxvYWQgfSkgPT4gdm9pZCA9IChcclxuICAgIGh0dHBDb250ZXh0XHJcbiAgKSA9PiB7fVxyXG4pID0+XHJcbiAgY3JlYXRlRWZmZWN0KCgpID0+XHJcbiAgICBhY3Rpb25zJC5waXBlKFxyXG4gICAgICBvZlR5cGUodGFja2luZ0FjdGlvbi5sb2FkaW5nKSxcclxuICAgICAgc3dpdGNoTWFwKChhY3Rpb24pID0+XHJcbiAgICAgICAgc2VydmljZUNhbGwoYWN0aW9uLnJlcXVlc3QpLnBpcGUoXHJcbiAgICAgICAgICBtYXAoKHBheWxvYWQpID0+IHRhY2tpbmdBY3Rpb24ubG9hZGVkKHsgcGF5bG9hZCB9KSksXHJcbiAgICAgICAgICB0YXAoKHN1Y2Nlc3NBY3Rpb24pID0+XHJcbiAgICAgICAgICAgIHN1Y2Nlc3NGbih7XHJcbiAgICAgICAgICAgICAgcmVxdWVzdDogYWN0aW9uLnJlcXVlc3QsXHJcbiAgICAgICAgICAgICAgcGF5bG9hZDogc3VjY2Vzc0FjdGlvbi5wYXlsb2FkLFxyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgKSxcclxuICAgICAgICAgIGNhdGNoRXJyb3IoKGUpID0+IHtcclxuICAgICAgICAgICAgY29uc29sZS5lcnJvcihlKTtcclxuICAgICAgICAgICAgY29uc3Qgc3ViamVjdE1zZyA9IG5ldyBTdWJqZWN0PEFjdGlvbj4oKTtcclxuXHJcbiAgICAgICAgICAgIGlmIChcclxuICAgICAgICAgICAgICBlLmVycm9yIGluc3RhbmNlb2YgQmxvYiAmJlxyXG4gICAgICAgICAgICAgIGUuZXJyb3IudHlwZSA9PT0gJ2FwcGxpY2F0aW9uL2pzb24nXHJcbiAgICAgICAgICAgICkge1xyXG4gICAgICAgICAgICAgIGUuZXJyb3IudGV4dCgpLnRoZW4oKGVycm9yQmxvYlRleHQ6IHN0cmluZykgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgZXJyb3JKc29uID0gSlNPTi5wYXJzZShlcnJvckJsb2JUZXh0KTtcclxuICAgICAgICAgICAgICAgIHN1YmplY3RNc2cubmV4dCh0YWNraW5nQWN0aW9uLmZhaWx1cmUoZSwgZXJyb3JKc29uLmVycm9yKSk7XHJcbiAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgcmV0dXJuIG9mKHRhY2tpbmdBY3Rpb24uZmFpbHVyZShlLCBmYWxsYmFja0Vycm9yTXNnKSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIHN1YmplY3RNc2c7XHJcbiAgICAgICAgICB9KVxyXG4gICAgICAgIClcclxuICAgICAgKVxyXG4gICAgKVxyXG4gICk7XHJcbiJdfQ==